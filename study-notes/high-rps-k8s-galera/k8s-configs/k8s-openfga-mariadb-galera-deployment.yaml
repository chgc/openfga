---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: openfga-prod

---
# Secret for MariaDB 密碼
apiVersion: v1
kind: Secret
metadata:
  name: mariadb-secret
  namespace: openfga-prod
type: Opaque
stringData:
  root-password: "your-secure-password-here"
  replication-user: "replicator"
  replication-password: "replication-password-here"

---
# ConfigMap for MariaDB Galera 配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-galera-config
  namespace: openfga-prod
data:
  galera.cnf: |
    [mysqld]
    # 基本連接設置
    max_connections = 2000
    max_allowed_packet = 64M
    bind-address = 0.0.0.0
    port = 3306

    # InnoDB 設置
    default_storage_engine = InnoDB
    innodb_buffer_pool_size = 2G
    innodb_log_file_size = 512M
    innodb_file_per_table = 1
    innodb_flush_log_at_trx_commit = 2

    # 日誌設置
    server-id = 1
    log_bin = /var/lib/mysql/mysql-bin
    binlog_format = ROW

    # 字符集
    character_set_server = utf8mb4
    collation_server = utf8mb4_unicode_ci

    # 連接管理
    interactive_timeout = 600
    wait_timeout = 600

    # Galera 配置
    [galera]
    wsrep_on = ON
    wsrep_provider = /usr/lib/galera/libgalera_smm.so
    wsrep_provider_options = "gcache.size=2G;gcache.page_size=512M"
    wsrep_cluster_name = openfga-galera-cluster
    wsrep_sst_method = rsync
    wsrep_slave_threads = 8
    wsrep_max_ws_rows = 131072
    wsrep_max_ws_size = 1G

    # 性能優化
    key_buffer_size = 512M
    tmp_table_size = 32M
    max_heap_table_size = 32M
    query_cache_size = 0
    query_cache_type = 0

---
# StorageClass for fast SSD storage
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
allowVolumeExpansion: true

---
# MariaDB Galera StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mariadb-galera
  namespace: openfga-prod
  labels:
    app: mariadb-galera
spec:
  serviceName: mariadb-galera
  replicas: 3
  selector:
    matchLabels:
      app: mariadb-galera

  template:
    metadata:
      labels:
        app: mariadb-galera
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9104"

    spec:
      # Pod 反親和性：確保 Galera 節點分散到不同的 K8s 節點
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - mariadb-galera
              topologyKey: kubernetes.io/hostname

      # 初始化容器：等待 Galera 集群就緒
      initContainers:
        - name: wait-for-cluster
          image: busybox:latest
          command:
            - "sh"
            - "-c"
            - |
              echo "Waiting for Galera cluster..."
              # 這裡可以檢查其他節點是否準備好
              sleep 10

      containers:
        - name: mariadb
          image: mariadb:11.4

          # 環境變數
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-secret
                  key: root-password

            - name: MYSQL_DATABASE
              value: "openfga"

            - name: MYSQL_REPLICATION_USER
              valueFrom:
                secretKeyRef:
                  name: mariadb-secret
                  key: replication-user

            - name: MYSQL_REPLICATION_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-secret
                  key: replication-password

            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name

            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          # 端口
          ports:
            - containerPort: 3306
              name: mysql
              protocol: TCP
            - containerPort: 4567
              name: galera
              protocol: TCP
            - containerPort: 4568
              name: ist
              protocol: TCP
            - containerPort: 4444
              name: sst
              protocol: TCP

          # 資源限制
          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "4000m"
              memory: "4Gi"

          # 卷掛載
          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
            - name: config
              mountPath: /etc/mysql/conf.d

          # 存活探針
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - mysqladmin ping -h localhost
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # 就緒探針
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - mysql -h localhost -e "SELECT 1"
            initialDelaySeconds: 20
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2

      # 卷
      volumes:
        - name: config
          configMap:
            name: mariadb-galera-config

      # 終止寬限期
      terminationGracePeriodSeconds: 300

  # 卷聲稱模板
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 100Gi

---
# Headless Service for Galera Pod-to-Pod communication
apiVersion: v1
kind: Service
metadata:
  name: mariadb-galera
  namespace: openfga-prod
  labels:
    app: mariadb-galera
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: mariadb-galera
  ports:
    - name: mysql
      port: 3306
      targetPort: 3306
    - name: galera
      port: 4567
      targetPort: 4567
    - name: ist
      port: 4568
      targetPort: 4568
    - name: sst
      port: 4444
      targetPort: 4444

---
# ClusterIP Service for OpenFGA access
apiVersion: v1
kind: Service
metadata:
  name: mariadb-galera-lb
  namespace: openfga-prod
  labels:
    app: mariadb-galera
spec:
  type: ClusterIP
  selector:
    app: mariadb-galera
  sessionAffinity: None
  ports:
    - name: mysql
      port: 3306
      targetPort: 3306
      protocol: TCP

---
# OpenFGA Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openfga
  namespace: openfga-prod
  labels:
    app: openfga
spec:
  replicas: 8 # 根據 RPS 調整，推薦 8-12

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1

  selector:
    matchLabels:
      app: openfga

  template:
    metadata:
      labels:
        app: openfga
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"

    spec:
      # Pod 反親和性：分散到不同節點
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - openfga
                topologyKey: kubernetes.io/hostname

      # 優雅關閉
      terminationGracePeriodSeconds: 30

      containers:
        - name: openfga
          image: openfga/openfga:latest
          imagePullPolicy: Always

          # 端口
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: grpc
              containerPort: 8081
              protocol: TCP

          # 關鍵的連接池配置
          env:
            # 基本配置
            - name: OPENFGA_DATASTORE_ENGINE
              value: "mysql"

            - name: OPENFGA_DATASTORE_URI
              value: "root:$(MYSQL_ROOT_PASSWORD)@tcp(mariadb-galera-lb.openfga-prod:3306)/openfga"

            # 連接池參數（根據高 RPS 優化）
            - name: OPENFGA_DATASTORE_MAX_OPEN_CONNS
              value: "150"

            - name: OPENFGA_DATASTORE_MAX_IDLE_CONNS
              value: "50"

            - name: OPENFGA_DATASTORE_CONN_MAX_IDLE_TIME
              value: "60s"

            - name: OPENFGA_DATASTORE_CONN_MAX_LIFETIME
              value: "10m"

            # 超時設置
            - name: OPENFGA_GRPC_UPSTREAMTIMEOUT
              value: "30s"

            - name: OPENFGA_HTTP_UPSTREAMTIMEOUT
              value: "30s"

            # 日誌和追蹤
            - name: OPENFGA_LOG_LEVEL
              value: "info"

            - name: OPENFGA_LOG_FORMAT
              value: "json"

            - name: OPENFGA_TRACE_ENABLED
              value: "false"

            # 性能相關
            - name: OPENFGA_MAX_TUPLES_PER_WRITE
              value: "100"

            # 密碼
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-secret
                  key: root-password

          # 資源配置
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

          # 存活探針 (gRPC)
          livenessProbe:
            grpc:
              port: 8081
            initialDelaySeconds: 15
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3

          # 就緒探針 (gRPC)
          readinessProbe:
            grpc:
              port: 8081
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 2

          # 優雅關閉
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 10"]

          # 安全上下文
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

---
# OpenFGA Service - gRPC
apiVersion: v1
kind: Service
metadata:
  name: openfga-grpc
  namespace: openfga-prod
  labels:
    app: openfga
spec:
  type: ClusterIP
  selector:
    app: openfga
  ports:
    - name: grpc
      port: 8081
      targetPort: 8081
      protocol: TCP

---
# OpenFGA Service - HTTP
apiVersion: v1
kind: Service
metadata:
  name: openfga-http
  namespace: openfga-prod
  labels:
    app: openfga
spec:
  type: LoadBalancer
  selector:
    app: openfga
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP

---
# HorizontalPodAutoscaler for OpenFGA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: openfga-hpa
  namespace: openfga-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: openfga

  minReplicas: 8
  maxReplicas: 20

  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60

    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30

---
# PodDisruptionBudget for OpenFGA
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: openfga-pdb
  namespace: openfga-prod
spec:
  minAvailable: 4
  selector:
    matchLabels:
      app: openfga

---
# PodDisruptionBudget for MariaDB Galera
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mariadb-galera-pdb
  namespace: openfga-prod
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: mariadb-galera

---
# NetworkPolicy - 限制流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openfga-network-policy
  namespace: openfga-prod
spec:
  podSelector:
    matchLabels:
      app: openfga
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8081
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: mariadb-galera
      ports:
        - protocol: TCP
          port: 3306
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53

---
# Monitoring ServiceMonitor (for Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: openfga
  namespace: openfga-prod
spec:
  selector:
    matchLabels:
      app: openfga
  endpoints:
    - port: http
      interval: 30s
      path: /metrics

---
# Monitoring ServiceMonitor for MariaDB
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mariadb-galera
  namespace: openfga-prod
spec:
  selector:
    matchLabels:
      app: mariadb-galera
  endpoints:
    - port: mysql
      interval: 30s
